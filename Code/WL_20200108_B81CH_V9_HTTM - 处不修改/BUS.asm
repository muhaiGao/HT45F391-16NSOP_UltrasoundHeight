;INCLUDE HT45F39.INC
;INCLUDE MACRO.INC
;INCLUDE USER.INC
;INCLUDE MEASURE.INC
;
;
;#define		P_INT		PA2
;#define		PC_INT		PAC2
;#define 	CS		PB2
;#define 	DIR_CS		PBC2
;#define		SCLK		PB0
;#define		DIR_SCLK	PBC0
;#define		SDI		PA6
;#define		DIR_SDI		PAC6
;#define		SDO		PA4
;#define		DIR_SDO		PAC4
;
;#define		P_UART		PB.0
;#define		UART_TUNE	134
;
;
;RAMBANK		0		RAMBANK0
;RAMBANK0	.SECTION	'data'
;
;R_SPI_DATA			DB		6		DUP(0)
;R_SPI_CNT			DB		?
;R_DATA				DB		?
;F_NORMAL_MODE			DBIT
;F_TEST_MODE			DBIT
;F_CHECK_OK			DBIT
;F_CHECK_ERR			DBIT
;bus	.SECTION	at 190h 'CODE'
;
;
;
;
;SBR_SPI_READ:
;	SET	DIR_CS
;	SET	DIR_SCLK
;	SET	DIR_SDI
;	
;	; CLR	WDT
;	; SNZ	CS
;	; JMP	$-2
;	
;	CLR	WDT
;	SZ	CS
;	JMP	$-2
;	
;	MOVF	R_SPI_CNT,8
;	CLR	R_DATA
;	
;L_START_RECEIVE:		
;$0:
;	CLR	WDT	
;	SZ	CS
;	JMP	SBR_SPI_READ_EXIT	
;	SZ	SCLK
;	JMP	$0
;$1:	
;	CLR	WDT
;	SZ	CS
;	JMP	SBR_SPI_READ_EXIT
;	SNZ	SCLK
;	JMP	$1
;	
;	SZ	SDI
;	SET	R_DATA.0
;	
;	SDZ	R_SPI_CNT
;	JMP	$4
;	JMP	SBR_SPI_READ_EXIT
;$4:	
;	RL	R_DATA
;	JMP	L_START_RECEIVE
;	
;	
;	
;SBR_SPI_READ_EXIT:
;		
;	RET
;	
;SBR_SPI_WRITE:
;	SET	DIR_CS
;	SET	DIR_SCLK
;	CLR	DIR_SDO
;	
;	CLR	WDT
;	; SNZ	CS
;	; JMP	$-2
;	
;	CLR	WDT
;	SZ	CS
;	JMP	$-2
;	
;	MOVF	R_SPI_CNT,8
;
;$0:	
;	CLR	WDT
;	SZ	CS
;	JMP	SBR_SPI_WRITE_EXIT
;	SZ	SCLK
;	JMP	$0
;	
;L_START_WRITE:	
;	SNZ	R_DATA.7
;	CLR	SDO
;	SZ	R_DATA.7
;	SET	SDO
;$1:	
;	CLR	WDT
;	SZ	CS
;	JMP	SBR_SPI_WRITE_EXIT
;	SNZ	SCLK
;	JMP	$1
;$2:	
;	CLR	WDT
;	SZ	CS
;	JMP	SBR_SPI_WRITE_EXIT
;	SZ	SCLK
;	JMP	$2
;	
;
;	SDZ	R_SPI_CNT
;	JMP	$3
;	JMP	SBR_SPI_WRITE_EXIT
;$3:
;	RL	R_DATA
;	JMP	L_START_WRITE
;	
;SBR_SPI_WRITE_EXIT:
;	RET	
;
;SBR_REV_CMD:
;	CLR	F_NORMAL_MODE
;	CLR	F_TEST_MODE
;	CLR	F_CHECK_OK
;	CLR	F_CHECK_ERR
;	
;	CALL	SBR_SPI_READ
;	MOV	A,R_DATA
;	XOR	A,5AH
;	SNZ	Z
;	JMP	L_REV_CMD_EXIT
;	
;	MOVF	__R_TEMP0,6
;	MOVF	MP0,OFFSET R_SPI_DATA
;L_REV_MODE_LOOP:
;	CALL	SBR_SPI_READ
;	MOVF	IAR0,R_DATA
;	INC 	MP0
;	SDZ	__R_TEMP0
;	JMP	L_REV_MODE_LOOP
;	
;	CALL	SBR_SPI_READ
;	MOV	A,R_DATA
;	XOR	A,0DH
;	SNZ	Z
;	JMP	L_REV_CMD_EXIT
;
;L_CHECK_SUM:
;	MOVF	__R_TEMP0,R_SPI_DATA[0]
;	MOVF	__R_TEMP1,R_SPI_DATA[1]
;	MOVF	__R_TEMP2,R_SPI_DATA[2]
;	MOVF	__R_TEMP3,R_SPI_DATA[3]
;	MOV	A,__R_TEMP2
;	ADDM	A,__R_TEMP0
;	MOV	A,__R_TEMP3
;	ADCM	A,__R_TEMP1
;	SNZ	C
;	JMP	$0
;	CLR	ACC
;	ADCM	A,__R_TEMP0
;	CLR	ACC
;	ADCM	A,__R_TEMP1
;$0:
;	MOV	A,R_SPI_DATA[4]
;	XOR	A,__R_TEMP0
;	SNZ	Z
;	JMP	L_REV_CMD_EXIT
;	MOV	A,R_SPI_DATA[5]
;	XOR	A,__R_TEMP1
;	SNZ	Z
;	JMP	L_REV_CMD_EXIT
;
;	MOV	A,R_SPI_DATA[1]
;	XOR	A,60H
;	SZ	Z
;	JMP	L_CMD_MODE
;	
;	MOV	A,R_SPI_DATA[1]
;	XOR	A,50H
;	SZ	Z
;	JMP	L_ACK_MODE
;	JMP	L_REV_CMD_EXIT
;L_CMD_MODE:
;	MOV	A,R_SPI_DATA[3]
;	XOR	A,05H
;	SNZ	Z
;	JMP	L_REV_CMD_EXIT
;	
;	MOV	A,R_SPI_DATA[2]
;	XOR	A,02H
;	SNZ	Z
;	JMP	$0
;	SET	F_NORMAL_MODE
;	JMP	L_REV_CMD_EXIT
;	
;$0:
;	MOV	A,R_SPI_DATA[2]
;	XOR	A,03H
;	SNZ	Z
;	JMP	L_REV_CMD_EXIT
;	SET	F_TEST_MODE
;	JMP	L_REV_CMD_EXIT
;
;L_ACK_MODE:
;	MOV	A,R_SPI_DATA[3]
;	XOR	A,4FH
;	SNZ	Z
;	JMP	$0
;	
;	MOV	A,R_SPI_DATA[2]
;	XOR	A,4BH
;	SNZ	Z
;	JMP	L_REV_CMD_EXIT
;	SET	F_CHECK_OK
;	JMP	L_REV_CMD_EXIT
;$0:
;	MOV	A,R_SPI_DATA[3]
;	XOR	A,4EH
;	SNZ	Z
;	JMP	L_REV_CMD_EXIT
;	
;	MOV	A,R_SPI_DATA[2]
;	XOR	A,47H
;	SNZ	Z
;	JMP	L_REV_CMD_EXIT
;	SET	F_CHECK_ERR
;	JMP	L_REV_CMD_EXIT
;L_REV_CMD_EXIT:	
;	RET
;	
;SBR_SND_DATA:
;;	CLR	P_INT
;	MOVF	R_DATA,5AH
;	CALL	SBR_SPI_WRITE
;	MOVF	R_DATA,0A9H
;	CALL	SBR_SPI_WRITE
;	MOVF	R_DATA,30H
;	CALL	SBR_SPI_WRITE
;	
;	MOVF	R_DATA,__R_DISTANCE_L
;	CALL	SBR_SPI_WRITE
;	MOVF	R_DATA,__R_DISTANCE_H
;	CALL	SBR_SPI_WRITE
;	
;	MOVF	__R_TEMP0,0A9H
;	MOVF	__R_TEMP1,30H
;	MOVF	__R_TEMP2,__R_DISTANCE_L
;	MOVF	__R_TEMP3,__R_DISTANCE_H
;	MOV	A,__R_TEMP2
;	ADDM	A,__R_TEMP0
;	MOV	A,__R_TEMP3
;	ADCM	A,__R_TEMP1
;	SNZ	C
;	JMP	$0
;	CLR	ACC
;	ADCM	A,__R_TEMP0
;	CLR	ACC
;	ADCM	A,__R_TEMP1
;$0:	
;	MOVF	R_DATA,__R_TEMP0
;	CALL	SBR_SPI_WRITE
;	MOVF	R_DATA,__R_TEMP1
;	CALL	SBR_SPI_WRITE
;	
;	MOVF	R_DATA,0DH
;	CALL	SBR_SPI_WRITE
;;	SET	P_INT
;	RET
;	
;
;	
;	
;	
;	
;	
;PUBLIC		F_NORMAL_MODE	
;PUBLIC		F_TEST_MODE
;PUBLIC		F_CHECK_OK
;PUBLIC		F_CHECK_ERR
;	
;	
;PUBLIC		SBR_SND_DATA	
;PUBLIC		SBR_REV_CMD	
;PUBLIC		SBR_SPI_READ
;PUBLIC		SBR_SPI_WRITE	
;;PUBLIC		SBR_UART_TX
;	
;PUBLIC		R_DATA
;END